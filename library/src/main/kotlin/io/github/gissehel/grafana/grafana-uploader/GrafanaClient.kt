package io.github.gissehel.grafana.grafanauploader

import io.github.gissehel.grafana.grafanauploader.error.CommunicationError
import io.github.gissehel.grafana.grafanauploader.model.Credential
import io.github.gissehel.grafana.grafanauploader.model.Folder
import io.github.gissehel.grafana.grafanauploader.utils.DebugLoggable
import io.github.gissehel.grafana.grafanauploader.utils.getUidFromVuid
import kotlinx.serialization.json.Json
import kotlinx.serialization.json.buildJsonObject
import kotlinx.serialization.json.put

class GrafanaClient(
    val rootUrl: String,
    val credential: Credential,
    val onDebug : ((String) -> Unit)? = null
) : DebugLoggable(onDebug) {
    private var _http_client : HttpClient? = null
    private val httpClient : HttpClient get() {
        if (_http_client == null) {
            HttpClient(rootUrl, credential, onDebug).also { _http_client = it }
        }
        return _http_client!!
    }

    private val getFoldersUrl: String get() = "/api/folders"
    private fun getFolderUrl(uid: String): String = "/api/folders/${uid}"
    private val getDashboardsUrl: String get() = "/api/dashboards/db"

    fun createFolderIfNotExists(vuid: String, title: String, parentVuid: String) {
        var exists = false
        val uid = vuid.getUidFromVuid()
        val parentUid = parentVuid.getUidFromVuid()
        try {
            httpClient.getJson(getFolderUrl(uid)) { jsonElement ->
                debugLog("Json: $jsonElement")
                exists = true
            }
        } catch (e: CommunicationError) {
            debugLog("Communication error: [${e.asCode}]")
        }
        if (!exists) {
            val folder = Folder(uid = uid, title = title, parentUid = parentUid)
            httpClient.postJson(getFoldersUrl, folder) { jsonElement ->
                debugLog("Created folder [${uid}] ($vuid)")
                debugLog("Json: ${jsonElement}")
            }
        }
    }

    fun createOrUpdateDashboard(dashboard: String, folderVuid: String) {
        val dashboardRequest = buildJsonObject {
            put("dashboard", Json.parseToJsonElement(dashboard))
            put("folderUid", folderVuid.getUidFromVuid())
            put("message", "autogenerated")
            put("overwrite", true)
        }
        try {
            httpClient.postJson(getDashboardsUrl, dashboardRequest) { jsonElement ->
                debugLog("Send diagram response: $jsonElement")
            }
        } catch (e: CommunicationError) {
            debugLog("Communication error: [${e.asCode}]")
        }
    }
}